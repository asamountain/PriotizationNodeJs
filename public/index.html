<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Priority Task Manager</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script type="module" src="https://unpkg.com/vue@3/dist/vue.esm-browser.js"></script>
</head>
<body>
    <!-- Add this notification container just after the body opening tag -->
    <div id="notification-container"></div>
    
    <div id="app" class="container" :data-theme="currentTheme" :class="{'dark-theme': isDarkTheme}">
        <header class="app-header">
            <h1 class="app-title">Priority Task Manager</h1>
            <div class="header-controls">
                <button @click="toggleTheme" class="theme-toggle" :aria-label="isDarkTheme ? 'Switch to light theme' : 'Switch to dark theme'">
                    <i :class="isDarkTheme ? 'fas fa-sun' : 'fas fa-moon'"></i>
                </button>
                <button @click="showStatsView = !showStatsView" class="stats-toggle" :class="{ active: showStatsView }">
                    <i class="fas fa-chart-pie"></i> {{ showStatsView ? 'Hide Stats' : 'Show Stats' }}
                </button>
            </div>
        </header>

        <div class="chart-container">
            <div id="taskChart"></div>
        </div>

        <!-- Statistics View - New Section -->
        <div class="stats-view" v-if="showStatsView">
            <h2>Task Statistics</h2>
            <div class="stats-container">
                <!-- Completion Stats -->
                <div class="stats-card">
                    <h3>Completion Statistics</h3>
                    <div class="stats-item">
                        <div class="stats-label">Tasks Completed:</div>
                        <div class="stats-value">{{ completedTasks.length }}</div>
                    </div>
                    <div class="stats-item">
                        <div class="stats-label">Completion Rate:</div>
                        <div class="stats-value">{{ Math.round((completedTasks.length / (activeTasks.length + completedTasks.length)) * 100) || 0 }}%</div>
                    </div>
                </div>
                
                <!-- Quadrant Stats -->
                <div class="stats-card">
                    <h3>Tasks by Quadrant</h3>
                    <div class="stats-item" v-for="(count, quadrant) in tasksByQuadrant" :key="quadrant">
                        <div class="stats-label">{{ quadrantLabels[quadrant] }}:</div>
                        <div class="stats-value">{{ count }}</div>
                    </div>
                </div>
                
                <!-- Time Stats -->
                <div class="stats-card">
                    <h3>Time Analysis</h3>
                    <div class="stats-item">
                        <div class="stats-label">Average Time to Complete:</div>
                        <div class="stats-value">{{ averageCompletionTime }}</div>
                    </div>
                    <div class="stats-item">
                        <div class="stats-label">Most Productive Day:</div>
                        <div class="stats-value">{{ mostProductiveDay }}</div>
                    </div>
                </div>
            </div>
            
            <!-- Completion Timeline Chart -->
            <div class="timeline-chart">
                <h3>Completion Timeline</h3>
                <div id="completionChart"></div>
            </div>
        </div>

        <form class="task-form" @submit.prevent="submitTask">
            <div class="form-group">
                <label class="form-label" for="taskName">Task Name</label>
                <input 
                    type="text" 
                    id="taskName" 
                    v-model="taskName"
                    class="form-input"
                    placeholder="Enter task name"
                    required
                >
            </div>

            <div class="slider-container">
                <div class="slider-group">
                    <label class="form-label" for="importance">
                        Importance: {{ taskImportance }}
                    </label>
                    <input
                        type="range"
                        id="importance"
                        v-model.number="taskImportance"
                        min="0"
                        max="10"
                        step="1"
                    >
                </div>

                <div class="slider-group">
                    <label class="form-label" for="urgency">
                        Urgency: {{ taskUrgency }}
                    </label>
                    <input
                        type="range"
                        id="urgency"
                        v-model.number="taskUrgency"
                        min="0"
                        max="10"
                        step="1"
                    >
                </div>
            </div>

            <button type="submit" class="btn">Add Task</button>
        </form>

        <!-- Task list -->
        <div class="task-container">
            <!-- Active Tasks Section -->
            <section class="task-section" id="active-tasks">
                <div class="section-header">
                    <h2>Active Tasks ({{ activeTasks.length }})</h2>
                    <div class="subtasks-filter-controls">
                        <button class="subtasks-filter-toggle" @click="toggleCompletedSubtasks">
                            <i class="fas" :class="showCompletedSubtasks ? 'fa-eye' : 'fa-eye-slash'"></i>
                            {{ showCompletedSubtasks ? 'Hide' : 'Show' }} Completed Subtasks
                        </button>
                    </div>
                </div>
                
                <div class="task-table-container" v-if="taskSectionOpen.active">
                    <table class="task-table">
                        <tbody>
                            <!-- For each parent task -->
                            <template v-for="task in activeTasks" :key="task.id">
                                <!-- Parent task row -->
                                <tr class="task vue-task-item" 
                                    :data-task-id="task.id" 
                                    @click="selectTask(task)">
                                    <td class="task-info">
                                        <div class="task-info-content">
                                            <input type="checkbox" class="task-checkbox" @click.stop="toggleTaskDone(task)">
                                            <div class="task-name-container">
                                                <span class="task-name">{{ task.name }}</span>
                                                <span class="task-date" v-if="task.due_date">Due: {{ formatDate(task.due_date) }}</span>
                                                
                                                <!-- Add metrics gauges -->
                                                <div class="metrics-gauges">
                                                    <div class="metric-gauge">
                                                        <div class="gauge-label">Importance</div>
                                                        <div class="gauge-container">
                                                            <div class="gauge-bar importance-bar" :style="{ width: (task.importance * 10) + '%', backgroundColor: task.importance > 7 ? 'var(--q1-color, #ff5252)' : task.importance > 4 ? 'var(--q2-color, #4caf50)' : task.importance > 2 ? 'var(--q3-color, #2196f3)' : 'var(--q4-color, #9e9e9e)' }"></div>
                                                            <span class="gauge-value">{{task.importance}}</span>
                                                        </div>
                                                    </div>
                                                    <div class="metric-gauge">
                                                        <div class="gauge-label">Urgency</div>
                                                        <div class="gauge-container">
                                                            <div class="gauge-bar urgency-bar" :style="{ width: (task.urgency * 10) + '%', backgroundColor: task.urgency > 7 ? 'var(--q1-color, #ff5252)' : task.urgency > 4 ? 'var(--q3-color, #2196f3)' : 'var(--q4-color, #9e9e9e)' }"></div>
                                                            <span class="gauge-value">{{task.urgency}}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="task-metrics">
                                        <button class="add-subtask-btn" @click.stop="showAddSubtaskForm(task.id)">
                                            <i class="fas fa-plus"></i> Add
                                        </button>
                                    </td>
                                </tr>
                                
                                <!-- Subtasks directly after the parent task -->
                                <tr v-if="getSubtasksForTask(task.id).length > 0" class="subtasks-row">
                                    <td colspan="2" class="subtasks-cell">
                                        <div class="subtasks-container">
                                            <table class="subtask-table">
                                                <tbody>
                                                    <tr v-for="subtask in getSubtasksForTask(task.id)" 
                                                        :key="subtask.id" 
                                                        class="subtask" 
                                                        :class="{'completed': subtask.done, 'hidden': subtask.done && !showCompletedSubtasks}"
                                                        :data-subtask-id="subtask.id">
                                                        <td class="subtask-info">
                                                            <div class="subtask-status" 
                                                                :class="{ 'completed': subtask.done }" 
                                                                @click.stop="toggleTaskDone(subtask)">
                                                                <i v-if="subtask.done" class="fas fa-check"></i>
                                                            </div>
                                                            <span class="subtask-name" :class="{ 'completed': subtask.done }">
                                                                {{ subtask.name }}
                                                            </span>
                                                            <!-- Add metrics gauges for subtasks -->
                                                            <div class="metrics-gauges subtask-gauges">
                                                                <div class="metric-gauge">
                                                                    <div class="gauge-label">I</div>
                                                                    <div class="gauge-container">
                                                                        <div class="gauge-bar importance-bar" :style="{ width: (subtask.importance * 10) + '%', backgroundColor: subtask.importance > 7 ? 'var(--q1-color, #ff5252)' : subtask.importance > 4 ? 'var(--q2-color, #4caf50)' : subtask.importance > 2 ? 'var(--q3-color, #2196f3)' : 'var(--q4-color, #9e9e9e)', opacity: subtask.done ? '0.6' : '1' }"></div>
                                                                        <span class="gauge-value">{{subtask.importance}}</span>
                                                                    </div>
                                                                </div>
                                                                <div class="metric-gauge">
                                                                    <div class="gauge-label">U</div>
                                                                    <div class="gauge-container">
                                                                        <div class="gauge-bar urgency-bar" :style="{ width: (subtask.urgency * 10) + '%', backgroundColor: subtask.urgency > 7 ? 'var(--q1-color, #ff5252)' : subtask.urgency > 4 ? 'var(--q3-color, #2196f3)' : 'var(--q4-color, #9e9e9e)', opacity: subtask.done ? '0.6' : '1' }"></div>
                                                                        <span class="gauge-value">{{subtask.urgency}}</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <td class="subtask-metrics">
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- Completed Tasks Section with Toggle -->
            <div class="task-section" id="completed-tasks" v-if="hasCompletedTasks">
                <div class="section-header" @click="toggleTaskSection('completed')">
                    <h2><i class="fas fa-check-circle"></i> Completed Tasks ({{ completedTasks.length }})</h2>
                    <span class="toggle-icon"><i :class="taskSectionOpen.completed ? 'fas fa-chevron-up' : 'fas fa-chevron-down'"></i></span>
                </div>
                <div class="task-table-container" v-if="taskSectionOpen.completed">
                    <table class="task-table">
                        <tbody>
                            <!-- For each parent task -->
                            <template v-for="task in completedTasks" :key="task.id">
                                <!-- Parent task row -->
                                <tr class="task vue-task-item completed-task" 
                                    :data-task-id="task.id" 
                                    @click="selectTask(task)">
                                    <td class="task-info">
                                        <div class="task-info-content">
                                            <input type="checkbox" class="task-checkbox" checked @click.stop="toggleTaskDone(task)">
                                            <div class="task-name-container">
                                                <span class="task-name">{{ task.name }}</span>
                                                <span class="task-date" v-if="task.completed_at">Completed: {{ formatDate(task.completed_at) }}</span>
                                                
                                                <!-- Add metrics gauges for completed tasks -->
                                                <div class="metrics-gauges">
                                                    <div class="metric-gauge">
                                                        <div class="gauge-label">Importance</div>
                                                        <div class="gauge-container">
                                                            <div class="gauge-bar importance-bar" :style="{ width: (task.importance * 10) + '%', backgroundColor: task.importance > 7 ? 'var(--q1-color, #ff5252)' : task.importance > 4 ? 'var(--q2-color, #4caf50)' : task.importance > 2 ? 'var(--q3-color, #2196f3)' : 'var(--q4-color, #9e9e9e)', opacity: '0.6' }"></div>
                                                            <span class="gauge-value">{{task.importance}}</span>
                                                        </div>
                                                    </div>
                                                    <div class="metric-gauge">
                                                        <div class="gauge-label">Urgency</div>
                                                        <div class="gauge-container">
                                                            <div class="gauge-bar urgency-bar" :style="{ width: (task.urgency * 10) + '%', backgroundColor: task.urgency > 7 ? 'var(--q1-color, #ff5252)' : task.urgency > 4 ? 'var(--q3-color, #2196f3)' : 'var(--q4-color, #9e9e9e)', opacity: '0.6' }"></div>
                                                            <span class="gauge-value">{{task.urgency}}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="task-metrics">
                                        <button class="delete-task" @click.stop="deleteTask(task.id)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                
                                <!-- Subtasks directly after the parent task -->
                                <tr v-if="getSubtasksForTask(task.id).length > 0" class="subtasks-row">
                                    <td colspan="2" class="subtasks-cell">
                                        <div class="subtasks-container">
                                            <table class="subtask-table">
                                                <tbody>
                                                    <tr v-for="subtask in getSubtasksForTask(task.id)" 
                                                        :key="subtask.id" 
                                                        class="subtask" 
                                                        :class="{'completed': subtask.done, 'hidden': subtask.done && !showCompletedSubtasks}"
                                                        :data-subtask-id="subtask.id">
                                                        <td class="subtask-info">
                                                            <div class="subtask-status" 
                                                                :class="{ 'completed': subtask.done }" 
                                                                @click.stop="toggleTaskDone(subtask)">
                                                                <i v-if="subtask.done" class="fas fa-check"></i>
                                                            </div>
                                                            <span class="subtask-name" :class="{ 'completed': subtask.done }">
                                                                {{ subtask.name }}
                                                            </span>
                                                            <!-- Add metrics gauges for subtasks -->
                                                            <div class="metrics-gauges subtask-gauges">
                                                                <div class="metric-gauge">
                                                                    <div class="gauge-label">I</div>
                                                                    <div class="gauge-container">
                                                                        <div class="gauge-bar importance-bar" :style="{ width: (subtask.importance * 10) + '%', backgroundColor: subtask.importance > 7 ? 'var(--q1-color, #ff5252)' : subtask.importance > 4 ? 'var(--q2-color, #4caf50)' : subtask.importance > 2 ? 'var(--q3-color, #2196f3)' : 'var(--q4-color, #9e9e9e)', opacity: subtask.done ? '0.6' : '1' }"></div>
                                                                        <span class="gauge-value">{{subtask.importance}}</span>
                                                                    </div>
                                                                </div>
                                                                <div class="metric-gauge">
                                                                    <div class="gauge-label">U</div>
                                                                    <div class="gauge-container">
                                                                        <div class="gauge-bar urgency-bar" :style="{ width: (subtask.urgency * 10) + '%', backgroundColor: subtask.urgency > 7 ? 'var(--q1-color, #ff5252)' : subtask.urgency > 4 ? 'var(--q3-color, #2196f3)' : 'var(--q4-color, #9e9e9e)', opacity: subtask.done ? '0.6' : '1' }"></div>
                                                                        <span class="gauge-value">{{subtask.urgency}}</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <td class="subtask-metrics">
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Add this outside the task list to create a modal edit form -->
        <div v-if="showEditForm" class="edit-modal">
            <div class="edit-modal-content">
                <h4>Edit Subtask</h4>
                <div class="form-group">
                    <label class="form-label" for="editSubtaskName">Subtask Name</label>
                    <input 
                        type="text" 
                        id="editSubtaskName" 
                        v-model="editingSubtask.name"
                        class="form-input"
                        placeholder="Enter subtask name"
                        required
                    >
                </div>

                <div class="slider-container">
                    <div class="slider-group">
                        <label class="form-label" for="editSubtaskImportance">
                            Importance: {{ editingSubtask.importance }}
                        </label>
                        <input
                            type="range"
                            id="editSubtaskImportance"
                            v-model.number="editingSubtask.importance"
                            min="0"
                            max="10"
                            step="1"
                        >
                    </div>

                    <div class="slider-group">
                        <label class="form-label" for="editSubtaskUrgency">
                            Urgency: {{ editingSubtask.urgency }}
                        </label>
                        <input
                            type="range"
                            id="editSubtaskUrgency"
                            v-model.number="editingSubtask.urgency"
                            min="0"
                            max="10"
                            step="1"
                        >
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="editSubtaskParent">Parent Task (Active Only)</label>
                    <select 
                        id="editSubtaskParent" 
                        v-model="editingSubtask.parent_id"
                        class="form-select"
                    >
                        <option v-for="parentTask in possibleParents" :key="parentTask.id" :value="parentTask.id">
                            {{ parentTask.name }}
                        </option>
                    </select>
                    <!-- Add a message if no active parents are available -->
                    <div v-if="possibleParents.length === 0" class="form-help-text">
                        No active parent tasks available. Please create a new active task first.
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn" @click="saveSubtaskEdit">Save Changes</button>
                    <button type="button" class="btn-secondary" @click="cancelEdit">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Add Subtask Form Modal -->
        <div id="subtask-modal" class="modal" v-if="showSubtaskModal">
            <div class="modal-content">
                <span class="close-button" @click="closeSubtaskModal">&times;</span>
                <h3>Add Subtask</h3>
                <form @submit.prevent="addSubtask">
                    <div class="form-group">
                        <label for="subtask-name">Subtask Name</label>
                        <input type="text" id="subtask-name" v-model="newSubtask.name" required>
                    </div>
                    <div class="form-group">
                        <label for="subtask-importance">Importance (1-10)</label>
                        <input type="range" id="subtask-importance" v-model.number="newSubtask.importance" min="1" max="10" step="1">
                        <span class="range-value">{{ newSubtask.importance }}</span>
                    </div>
                    <div class="form-group">
                        <label for="subtask-urgency">Urgency (1-10)</label>
                        <input type="range" id="subtask-urgency" v-model.number="newSubtask.urgency" min="1" max="10" step="1">
                        <span class="range-value">{{ newSubtask.urgency }}</span>
                    </div>
                    <div class="form-group">
                        <label for="subtask-due-date">Due Date (Optional)</label>
                        <input type="date" id="subtask-due-date" v-model="newSubtask.due_date">
                    </div>
                    <div class="form-actions">
                        <button type="button" @click="closeSubtaskModal" class="btn-secondary">Cancel</button>
                        <button type="submit" class="btn-primary">Add Subtask</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.26/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.4.1/dist/socket.io.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="taskManager.js" type="module"></script>
    <script src="app.js" type="module"></script>
</body>
</html>
