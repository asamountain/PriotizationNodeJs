<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Priority Task Manager</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script type="module" src="https://unpkg.com/vue@3/dist/vue.esm-browser.js"></script>
    <style>
        /* Define theme variables */
        :root {
            /* Default theme (Blue) */
            --primary-color: #2196F3;
            --success-color: #4CAF50;
            --warning-color: #FFC107;
            --error-color: #F44336;
            --text-primary: #333;
            --text-secondary: #666;
            --background-primary: #fff;
            --background-secondary: #f5f5f5;
            
            /* Quadrant colors */
            --q1-color: #d32f2f;
            --q2-color: #1976d2;
            --q3-color: #ff9800;
            --q4-color: #757575;
        }
        
        /* Dark theme */
        [data-theme="dark"] {
            --primary-color: #64B5F6;
            --success-color: #81C784;
            --warning-color: #FFD54F;
            --error-color: #E57373;
            --text-primary: #E0E0E0;
            --text-secondary: #BDBDBD;
            --background-primary: #333;
            --background-secondary: #222;
            
            /* Quadrant colors */
            --q1-color: #EF5350;
            --q2-color: #42A5F5;
            --q3-color: #FFA726;
            --q4-color: #9E9E9E;
        }
        
        /* Purple theme */
        [data-theme="purple"] {
            --primary-color: #9C27B0;
            --success-color: #8BC34A;
            --warning-color: #FFEB3B;
            --error-color: #FF5722;
            --text-primary: #37474F;
            --text-secondary: #607D8B;
            --background-primary: #F3E5F5;
            --background-secondary: #E1BEE7;
            
            /* Quadrant colors */
            --q1-color: #C2185B;
            --q2-color: #7B1FA2;
            --q3-color: #FFA000;
            --q4-color: #5D4037;
        }
        
        /* Green theme */
        [data-theme="green"] {
            --primary-color: #4CAF50;
            --success-color: #009688;
            --warning-color: #CDDC39;
            --error-color: #F44336;
            --text-primary: #1B5E20;
            --text-secondary: #388E3C;
            --background-primary: #E8F5E9;
            --background-secondary: #C8E6C9;
            
            /* Quadrant colors */
            --q1-color: #D84315;
            --q2-color: #2E7D32;
            --q3-color: #F57F17;
            --q4-color: #455A64;
        }

        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background: var(--background-secondary);
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            box-sizing: border-box;
            width: 100%;
        }

        .app-header {
            text-align: center;
            margin-bottom: 2rem;
            color: var(--text-primary);
        }

        .app-title {
            font-size: 2.5rem;
            font-weight: 600;
            margin: 0;
            background: linear-gradient(45deg, var(--primary-color), var(--primary-color));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .chart-container {
            background: var(--background-primary);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            width: 100%;
            box-sizing: border-box;
        }

        .task-form {
            background: var(--background-primary);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .slider-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 1.5rem;
        }

        .slider-group {
            background: var(--background-secondary);
            padding: 1rem;
            border-radius: 8px;
        }

        input[type="range"] {
            width: 100%;
            margin: 0.5rem 0;
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(33, 150, 243, 0.3);
        }

        .task-list {
            display: grid;
            gap: 1rem;
        }

        .task {
            background: var(--background-primary);
            border-radius: 8px;
            padding: 1rem;
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }

        .task:hover {
            transform: translateY(-2px);
        }

        .task-info {
            display: grid;
            gap: 0.5rem;
        }

        .task-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .task-metrics {
            display: flex;
            gap: 1rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .toggle-done {
            background: none;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .toggle-done:hover {
            background: var(--primary-color);
            color: white;
        }

        .tooltip {
            position: absolute;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            pointer-events: none;
            font-size: 0.9rem;
            z-index: 1000;
            max-width: 200px;
        }

        .tooltip strong {
            color: var(--text-primary);
            display: block;
            margin-bottom: 0.5rem;
        }

        .tooltip-category {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 500;
            margin-top: 0.5rem;
        }

        .category-do-first { background: rgba(244, 67, 54, 0.1); color: #d32f2f; }
        .category-schedule { background: rgba(33, 150, 243, 0.1); color: #1976d2; }
        .category-delegate { background: rgba(255, 152, 0, 0.1); color: #f57c00; }
        .category-dont-do { background: rgba(158, 158, 158, 0.1); color: #757575; }

        /* Debug info and no-tasks message */
        .debug-info {
            background: var(--background-secondary);
            padding: 8px;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .no-tasks-message {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
            background: var(--background-secondary);
            border-radius: 8px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div id="app" class="container" :data-theme="currentTheme">
        <header class="app-header">
            <h1 class="app-title">Priority Task Manager</h1>
            
            <!-- Add theme switcher -->
            <div class="theme-switcher">
                <label for="theme-select">Theme:</label>
                <select id="theme-select" v-model="currentTheme" class="theme-select">
                    <option value="default">Blue (Default)</option>
                    <option value="dark">Dark</option>
                    <option value="purple">Purple</option>
                    <option value="green">Green</option>
                </select>
            </div>
        </header>

        <div id="priority-chart" class="chart-container">
            <!-- D3 chart will be rendered here -->
        </div>

        <form class="task-form" @submit.prevent="addTask">
            <div class="form-group">
                <label class="form-label" for="taskName">Task Name</label>
                <input 
                    type="text" 
                    id="taskName" 
                    v-model="newTask.name"
                    class="form-input"
                    placeholder="Enter task name"
                    required
                >
            </div>

            <div class="slider-container">
                <div class="slider-group">
                    <label class="form-label" for="importance">
                        Importance: {{ newTask.importance }}
                    </label>
                    <input
                        type="range"
                        id="importance"
                        v-model.number="newTask.importance"
                        min="0"
                        max="10"
                        step="1"
                    >
                </div>

                <div class="slider-group">
                    <label class="form-label" for="urgency">
                        Urgency: {{ newTask.urgency }}
                    </label>
                    <input
                        type="range"
                        id="urgency"
                        v-model.number="newTask.urgency"
                        min="0"
                        max="10"
                        step="1"
                    >
                </div>
            </div>

            <button type="submit" class="btn">Add Task</button>
        </form>

        <div class="task-list">
            <div class="task-list-header">
                <h3>Task List</h3>
                <button 
                    class="toggle-completed-btn"
                    @click="showCompleted = !showCompleted"
                >
                    {{ showCompleted ? 'Hide Completed' : 'Show Completed' }}
                </button>
            </div>
            
            <!-- Debug info to see if tasks are being received -->
            <div class="debug-info" style="margin-bottom: 10px; color: #666;">
                Total tasks: {{ tasks.length }}, 
                Active: {{ activeTasks.length }}, 
                Completed: {{ completedTasks.length }}
            </div>
            
            <!-- Active Tasks with inline subtask forms -->
            <div v-for="task in activeTasks" :key="task.id" class="task-container">
                <!-- Main task -->
                <div class="task">
                    <div class="task-info">
                        <span class="task-name">{{ task.name }}</span>
                        <div class="task-metrics">
                            <span>Importance: {{ task.importance }}</span>
                            <span>Urgency: {{ task.urgency }}</span>
                            <span v-if="task.done" class="task-done">✓ Completed</span>
                        </div>
                        
                        <!-- Subtasks section -->
                        <div v-if="getSubtasks(task.id).length > 0" class="subtasks-container">
                            <div class="subtasks-header">
                                <span>Subtasks:</span>
                            </div>
                            <div v-for="subtask in getOrderedSubtasks(task.id)" :key="subtask.id" class="subtask">
                                <div class="subtask-info">
                                    <span class="subtask-name">
                                        <span class="subtask-bullet">•</span> 
                                        {{ subtask.name }}
                                    </span>
                                    <div class="subtask-metrics">
                                        <span class="subtask-metric">I: {{ subtask.importance }}</span>
                                        <span class="subtask-metric">U: {{ subtask.urgency }}</span>
                                        <span v-if="subtask.done" class="task-done">✓</span>
                                    </div>
                                </div>
                                <button 
                                    class="toggle-done subtask-btn"
                                    @click="toggleDone(subtask.id)"
                                    :class="{ done: subtask.done }"
                                >
                                    {{ subtask.done ? 'Undo' : 'Done' }}
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="task-actions">
                        <button 
                            class="toggle-done"
                            @click="toggleDone(task.id)"
                            :class="{ done: task.done }"
                        >
                            {{ task.done ? 'Undo' : 'Done' }}
                        </button>
                        <button 
                            class="add-subtask-btn"
                            @click="showAddSubtask(task.id)"
                        >
                            + Subtask
                        </button>
                    </div>
                </div>
                
                <!-- Subtask Form (positioned directly below its parent task) -->
                <div v-if="showSubtaskForm && selectedTaskId === task.id" class="subtask-form">
                    <h4>Add Subtask to: {{ task.name }}</h4>
                    <div class="form-group">
                        <label class="form-label" for="subtaskName">Subtask Name</label>
                        <input 
                            type="text" 
                            id="subtaskName" 
                            v-model="newSubtask.name"
                            class="form-input"
                            placeholder="Enter subtask name"
                            required
                        >
                    </div>

                    <div class="slider-container">
                        <div class="slider-group">
                            <label class="form-label" for="subtaskImportance">
                                Importance: {{ newSubtask.importance }}
                            </label>
                            <input
                                type="range"
                                id="subtaskImportance"
                                v-model.number="newSubtask.importance"
                                min="0"
                                max="10"
                                step="1"
                            >
                        </div>

                        <div class="slider-group">
                            <label class="form-label" for="subtaskUrgency">
                                Urgency: {{ newSubtask.urgency }}
                            </label>
                            <input
                                type="range"
                                id="subtaskUrgency"
                                v-model.number="newSubtask.urgency"
                                min="0"
                                max="10"
                                step="1"
                            >
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn" @click="addSubtask">Add Subtask</button>
                        <button type="button" class="btn-secondary" @click="cancelAddSubtask">Cancel</button>
                    </div>
                </div>
            </div>
            
            <!-- Message when no active tasks -->
            <div v-if="activeTasks.length === 0" class="no-tasks-message">
                No active tasks. Add a task to get started!
            </div>
            
            <!-- Completed Tasks Section (conditionally shown) -->
            <div v-if="showCompleted && completedTasks.length > 0" class="completed-tasks-section">
                <h4>Completed Tasks</h4>
                <div v-for="task in completedTasks" :key="task.id" class="task completed-task">
                    <div class="task-info">
                        <span class="task-name">{{ task.name }}</span>
                        <div class="task-metrics">
                            <span>Importance: {{ task.importance }}</span>
                            <span>Urgency: {{ task.urgency }}</span>
                            <span class="task-done">✓ Completed</span>
                        </div>
                        
                        <!-- Subtasks section for completed tasks -->
                        <div v-if="getSubtasks(task.id).length > 0" class="subtasks-container">
                            <div class="subtasks-header">
                                <span>Subtasks:</span>
                            </div>
                            <div v-for="subtask in getOrderedSubtasks(task.id)" :key="subtask.id" class="subtask">
                                <div class="subtask-info">
                                    <span class="subtask-name">
                                        <span class="subtask-bullet">•</span> 
                                        {{ subtask.name }}
                                    </span>
                                    <div class="subtask-metrics">
                                        <span class="subtask-metric">I: {{ subtask.importance }}</span>
                                        <span class="subtask-metric">U: {{ subtask.urgency }}</span>
                                        <span v-if="subtask.done" class="task-done">✓</span>
                                    </div>
                                </div>
                                <button 
                                    class="toggle-done subtask-btn"
                                    @click="toggleDone(subtask.id)"
                                    :class="{ done: subtask.done }"
                                >
                                    {{ subtask.done ? 'Undo' : 'Done' }}
                                </button>
                            </div>
                        </div>
                    </div>
                    <button 
                        class="toggle-done done"
                        @click="toggleDone(task.id)"
                    >
                        Undo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { createApp } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js'
        import { TaskManager } from './taskManager.js'

        const app = createApp({
            data() {
                return {
                    tasks: [],
                    showCompleted: false,
                    currentTheme: 'default',
                    newTask: {
                        name: '',
                        importance: 5,
                        urgency: 5
                    },
                    newSubtask: {
                        name: '',
                        importance: 5,
                        urgency: 5
                    },
                    selectedTaskId: null,
                    showSubtaskForm: false
                }
            },
            computed: {
                activeTasks() {
                    return this.tasks.filter(task => !task.done && task.parent_id === null);
                },
                completedTasks() {
                    return this.tasks.filter(task => task.done && task.parent_id === null);
                },
                getSubtasks() {
                    return (parentId) => {
                        return this.tasks.filter(task => task.parent_id === parentId);
                    };
                },
                getOrderedSubtasks() {
                    return (parentId) => {
                        return this.tasks
                            .filter(task => task.parent_id === parentId)
                            .sort((a, b) => {
                                // Order by importance first (descending)
                                if (b.importance !== a.importance) {
                                    return b.importance - a.importance;
                                }
                                // Then by urgency (descending)
                                return b.urgency - a.urgency;
                            });
                    };
                },
                getTaskName() {
                    return (taskId) => {
                        const task = this.tasks.find(task => task.id === taskId);
                        return task ? task.name : '';
                    };
                }
            },
            watch: {
                currentTheme(newTheme) {
                    localStorage.setItem('priority-task-theme', newTheme);
                    if (this.taskManager) {
                        this.taskManager.updateChartColors();
                    }
                }
            },
            mounted() {
                console.log('Vue app mounted');
                this.taskManager = new TaskManager();
                
                this.taskManager.onTasksUpdate = (tasks) => {
                    console.log('onTasksUpdate called with', tasks.length, 'tasks');
                    this.tasks = tasks;
                };
                
                this.taskManager.setVueApp(this);
                
                const savedTheme = localStorage.getItem('priority-task-theme');
                if (savedTheme) {
                    this.currentTheme = savedTheme;
                }
            },
            methods: {
                addTask() {
                    console.log('Adding task:', this.newTask);
                    this.taskManager.addTask(this.newTask);
                    this.newTask = {
                        name: '',
                        importance: 5,
                        urgency: 5
                    };
                },
                toggleDone(taskId) {
                    console.log('Toggling done for task:', taskId);
                    this.taskManager.toggleDone(taskId);
                },
                showAddSubtask(taskId) {
                    console.log('Showing subtask form for task:', taskId);
                    this.selectedTaskId = taskId;
                    this.showSubtaskForm = true;
                    this.newSubtask = {
                        name: '',
                        importance: 5,
                        urgency: 5
                    };
                },
                addSubtask() {
                    if (this.selectedTaskId) {
                        console.log('Adding subtask to parent:', this.selectedTaskId);
                        this.taskManager.addSubtask(this.newSubtask, this.selectedTaskId);
                        this.newSubtask = {
                            name: '',
                            importance: 5,
                            urgency: 5
                        };
                        this.showSubtaskForm = false;
                    }
                },
                cancelAddSubtask() {
                    this.showSubtaskForm = false;
                    this.selectedTaskId = null;
                }
            }
        }).mount('#app')
    </script>
</body>
</html>
